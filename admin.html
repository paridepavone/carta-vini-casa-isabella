<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Gestione Vini</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div class="wrap">
        <header class="topbar">
            <h1 class="brand__name">Aggiungi Nuovo Vino</h1>
        </header>

        <section class="panel">
            <form id="wineForm" class="filters__grid">
                <div class="field field--full">
                    <label>Nome Vino</label>
                    <input type="text" id="titolo" required placeholder="Es. Amarone della Valpolicella">
                </div>
                <div class="field">
                    <label>Cantina</label>
                    <input type="text" id="cantina" required>
                </div>
                <div class="field">
                    <label>Prezzo (â‚¬)</label>
                    <input type="number" id="prezzo" step="0.50" required>
                </div>
                <div class="field">
                    <label>Foto Bottiglia</label>
                    <input type="file" id="foto" accept="image/*" capture="environment">
                </div>
                <div class="actions">
                    <button type="submit" class="btn" style="background: var(--bordeaux); color: white; padding: 15px;">Salva Vino</button>
                </div>
            </form>
            <div id="statusMsg" style="margin-top: 20px; font-weight: bold;"></div>
        </section>
    </div>

    <script>
        const SUPABASE_URL = 'IL_TUO_URL_SUPABASE';
        const SUPABASE_KEY = 'LA_TUA_CHIAVE_ANON';
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const form = document.getElementById('wineForm');
        
        form.onsubmit = async (e) => {
            e.preventDefault();
            const status = document.getElementById('statusMsg');
            status.innerText = "Caricamento in corso...";

            const file = document.getElementById('foto').files[0];
            let imageUrl = "";

            // 1. Carica la foto se presente
            if (file) {
                const fileName = `${Date.now()}_${file.name}`;
                const { data, error } = await supabase.storage
                    .from('bottiglie')
                    .upload(fileName, file);
                
                if (error) { status.innerText = "Errore foto: " + error.message; return; }
                
                const { data: publicUrl } = supabase.storage.from('bottiglie').getPublicUrl(fileName);
                imageUrl = publicUrl.publicUrl;
            }

            // 2. Salva i dati nel Database
            const { error: dbError } = await supabase.from('vini').insert([{
                titolo: document.getElementById('titolo').value,
                cantina: document.getElementById('cantina').value,
                prezzo: parseFloat(document.getElementById('prezzo').value),
                immagine_url: imageUrl
            }]);

            if (dbError) {
                status.innerText = "Errore DB: " + dbError.message;
            } else {
                status.innerText = "Vino salvato con successo! ðŸŽ‰";
                form.reset();
            }
        };
    </script>
</body>
</html>

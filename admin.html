<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Casa Isabella</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f4f4f4; }
        .form-card { background: white; padding: 20px; border-radius: 8px; max-width: 500px; margin: auto; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        input, select, textarea { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; background: #800020; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        button:disabled { background: #ccc; }
        #status { margin-top: 15px; text-align: center; font-weight: bold; }
    </style>
</head>
<body>

<div class="form-card">
    <h2>Aggiungi Nuovo Vino</h2>
    <input type="text" id="titolo" placeholder="Nome del vino (es. Barolo DOCG)" required>
    <input type="text" id="cantina" placeholder="Cantina">
    <select id="tipologia">
        <option value="Rosso">Rosso</option>
        <option value="Bianco">Bianco</option>
        <option value="Bollicine">Bollicine</option>
        <option value="Rosato">Rosato</option>
        <option value="Dolce">Dolce</option>
    </select>
    <input type="text" id="luogo" placeholder="Regione/Luogo">
    <input type="number" id="prezzo" placeholder="Prezzo (es. 25.50)" step="0.01">
    <textarea id="descrizione" placeholder="Descrizione o note..."></textarea>
    
    <label>Foto Bottiglia:</label>
    <input type="file" id="foto" accept="image/*">
    
    <button id="btnSalva">AGGIUNGI ALLA CARTA</button>
    <div id="status"></div>
</div>

<script>
    const SUPABASE_URL = "https://bxdermzgfunwpvgektnz.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ4ZGVybXpnZnVud3B2Z2VrdG56Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3MDk1NzksImV4cCI6MjA4NjI4NTU3OX0.yIr_RtG2WDDl09l5MY2MWFd2PnnoE0L3c0uVxBBzQCE";
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const btn = document.getElementById('btnSalva');
    const status = document.getElementById('status');

    btn.onclick = async () => {
        const titolo = document.getElementById('titolo').value;
        const file = document.getElementById('foto').files[0];
        
        if (!titolo) return alert("Inserisci almeno il titolo!");

        btn.disabled = true;
        status.innerText = "Caricamento in corso...";
        status.style.color = "orange";

        try {
            let immagine_url = "";

            // 1. Caricamento Foto (se presente)
            if (file) {
                const fileName = `${Date.now()}_${file.name.replace(/\s/g, '_')}`;
                const { data: uploadData, error: uploadError } = await _supabase.storage
                    .from('bottiglie')
                    .upload(fileName, file);

                if (uploadError) throw uploadError;

                const { data: publicUrlData } = _supabase.storage
                    .from('bottiglie')
                    .getPublicUrl(fileName);
                
                immagine_url = publicUrlData.publicUrl;
            }

            // 2. Caricamento Dati Tabella
            const { error: dbError } = await _supabase
                .from('vini')
                .insert([{
                    titolo: titolo,
                    cantina: document.getElementById('cantina').value,
                    tipologia: document.getElementById('tipologia').value,
                    luogo: document.getElementById('luogo').value,
                    prezzo: parseFloat(document.getElementById('prezzo').value) || 0,
                    descrizione: document.getElementById('descrizione').value,
                    immagine_url: immagine_url
                }]);

            if (dbError) throw dbError;

            status.innerText = "Vino inserito con successo! ðŸ·";
            status.style.color = "green";
            document.querySelectorAll('input, textarea').forEach(i => i.value = "");

        } catch (err) {
            console.error(err);
            status.innerText = "Errore: " + (err.message || "Controlla la console");
            status.style.color = "red";
        } finally {
            btn.disabled = false;
        }
    };
</script>

</body>
</html>
